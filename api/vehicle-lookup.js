// Compatibility database - embedded (71 vehicles across 11 makes)
const compatibilityDB = {
  "TOYOTA": [
    {
      "make": "Toyota",
      "model": "LandCruiser",
      "year_from": 2025,
      "year_to": 2025,
      "variant": "Prado",
      "has_2inch_hitch": true,
      "notes": "Factory-fitted integrated towbar with 50mm receiver (standard equipment)"
    },
    {
      "make": "Toyota",
      "model": "HiLux",
      "year_from": 2005,
      "year_to": 2025,
      "variant": "SR",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment. Requires dealer or aftermarket towbar"
    },
    {
      "make": "Toyota",
      "model": "HiLux",
      "year_from": 2005,
      "year_to": 2025,
      "variant": "SR5",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment. Requires dealer or aftermarket towbar"
    },
    {
      "make": "Toyota",
      "model": "HiLux",
      "year_from": 2005,
      "year_to": 2025,
      "variant": "Workmate",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment. Requires dealer or aftermarket towbar"
    },
    {
      "make": "Toyota",
      "model": "HiLux",
      "year_from": 2005,
      "year_to": 2025,
      "variant": "Rugged",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment. Requires dealer or aftermarket towbar"
    },
    {
      "make": "Toyota",
      "model": "HiLux",
      "year_from": 2005,
      "year_to": 2025,
      "variant": "Rugged X",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment. Requires dealer or aftermarket towbar"
    },
    {
      "make": "Toyota",
      "model": "HiLux",
      "year_from": 2005,
      "year_to": 2025,
      "variant": "Rogue",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment. Requires dealer or aftermarket towbar"
    },
    {
      "make": "Toyota",
      "model": "Fortuner",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "GXL",
      "has_2inch_hitch": false,
      "notes": "Genuine Toyota accessory available - not standard equipment"
    },
    {
      "make": "Toyota",
      "model": "Fortuner",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Crusade",
      "has_2inch_hitch": false,
      "notes": "Genuine Toyota accessory available - not standard equipment"
    }
  ],
  "NISSAN": [
    {
      "make": "Nissan",
      "model": "Navara",
      "year_from": 2021,
      "year_to": 2026,
      "variant": "PRO-4X",
      "has_2inch_hitch": true,
      "notes": "Factory-fitted towbar with 50mm receiver (standard equipment - exclusive to PRO-4X)"
    },
    {
      "make": "Nissan",
      "model": "Navara",
      "year_from": 2005,
      "year_to": 2020,
      "variant": "SL",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment (standard on PRO-4X only)"
    },
    {
      "make": "Nissan",
      "model": "Navara",
      "year_from": 2005,
      "year_to": 2020,
      "variant": "ST",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment (standard on PRO-4X only)"
    },
    {
      "make": "Nissan",
      "model": "Navara",
      "year_from": 2005,
      "year_to": 2020,
      "variant": "ST-X",
      "has_2inch_hitch": false,
      "notes": "Optional accessory - not standard equipment (standard on PRO-4X only)"
    },
    {
      "make": "Nissan",
      "model": "Patrol",
      "year_from": 2010,
      "year_to": 2025,
      "variant": "Ti",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    },
    {
      "make": "Nissan",
      "model": "Patrol",
      "year_from": 2010,
      "year_to": 2025,
      "variant": "Ti-L",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    },
    {
      "make": "Nissan",
      "model": "Pathfinder",
      "year_from": 2013,
      "year_to": 2025,
      "variant": "ST",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    },
    {
      "make": "Nissan",
      "model": "Pathfinder",
      "year_from": 2013,
      "year_to": 2025,
      "variant": "ST-L",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    },
    {
      "make": "Nissan",
      "model": "X-Trail",
      "year_from": 2014,
      "year_to": 2025,
      "variant": "ST",
      "has_2inch_hitch": false,
      "notes": "Genuine Nissan accessory available - not standard equipment"
    },
    {
      "make": "Nissan",
      "model": "X-Trail",
      "year_from": 2014,
      "year_to": 2025,
      "variant": "ST-L",
      "has_2inch_hitch": false,
      "notes": "Genuine Nissan accessory available - not standard equipment"
    }
  ],
  "FORD": [
    {
      "make": "Ford",
      "model": "Ranger",
      "year_from": 2026,
      "year_to": 2026,
      "variant": "Super Duty",
      "has_2inch_hitch": true,
      "notes": "Factory-fitted 4500kg-rated towbar (standard equipment - Super Duty only)"
    },
    {
      "make": "Ford",
      "model": "Ranger",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "XL",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) optional - physical towbar not standard equipment"
    },
    {
      "make": "Ford",
      "model": "Ranger",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "XLS",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) optional - physical towbar not standard equipment"
    },
    {
      "make": "Ford",
      "model": "Ranger",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "XLT",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) standard on XLT+ - physical towbar sold separately"
    },
    {
      "make": "Ford",
      "model": "Ranger",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "Wildtrak",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) standard on XLT+ - physical towbar sold separately"
    },
    {
      "make": "Ford",
      "model": "Ranger",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "Raptor",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) standard on XLT+ - physical towbar sold separately"
    },
    {
      "make": "Ford",
      "model": "Everest",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Ambiente",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) optional - physical towbar not standard equipment"
    },
    {
      "make": "Ford",
      "model": "Everest",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Trend",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) optional - physical towbar not standard equipment"
    },
    {
      "make": "Ford",
      "model": "Everest",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Titanium",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) standard on Sport+ - physical towbar sold separately"
    },
    {
      "make": "Ford",
      "model": "Everest",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Sport",
      "has_2inch_hitch": false,
      "notes": "Tow pack (wiring) standard on Sport+ - physical towbar sold separately"
    }
  ],
  "ISUZU": [
    {
      "make": "Isuzu",
      "model": "MU-X",
      "year_from": 2024,
      "year_to": 2025,
      "variant": "Tour Mate",
      "has_2inch_hitch": true,
      "notes": "Factory-fitted towbar kit with 50mm receiver (Tour Mate special edition only)"
    },
    {
      "make": "Isuzu",
      "model": "D-Max",
      "year_from": 2012,
      "year_to": 2025,
      "variant": "SX",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory (~$1284 fitted) - not standard equipment"
    },
    {
      "make": "Isuzu",
      "model": "D-Max",
      "year_from": 2012,
      "year_to": 2025,
      "variant": "LS-M",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory (~$1284 fitted) - not standard equipment"
    },
    {
      "make": "Isuzu",
      "model": "D-Max",
      "year_from": 2012,
      "year_to": 2025,
      "variant": "LS-U",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory (~$1284 fitted) - not standard equipment"
    },
    {
      "make": "Isuzu",
      "model": "D-Max",
      "year_from": 2012,
      "year_to": 2025,
      "variant": "LS-T",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory (~$1284 fitted) - not standard equipment"
    },
    {
      "make": "Isuzu",
      "model": "D-Max",
      "year_from": 2020,
      "year_to": 2025,
      "variant": "X-Terrain",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory (~$1284 fitted) - not standard equipment"
    },
    {
      "make": "Isuzu",
      "model": "MU-X",
      "year_from": 2013,
      "year_to": 2024,
      "variant": "LS-M",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory (~$1284 fitted) - not standard equipment (standard on Tour Mate only)"
    },
    {
      "make": "Isuzu",
      "model": "MU-X",
      "year_from": 2013,
      "year_to": 2024,
      "variant": "LS-U",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory (~$1284 fitted) - not standard equipment (standard on Tour Mate only)"
    },
    {
      "make": "Isuzu",
      "model": "MU-X",
      "year_from": 2013,
      "year_to": 2024,
      "variant": "LS-T",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory (~$1284 fitted) - not standard equipment (standard on Tour Mate only)"
    }
  ],
  "RAM": [
    {
      "make": "RAM",
      "model": "1500",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Laramie",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "RAM",
      "model": "1500",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Limited",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "RAM",
      "model": "2500",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Laramie",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "RAM",
      "model": "3500",
      "year_from": 2015,
      "year_to": 2025,
      "variant": "Laramie",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    }
  ],
  "CHEVROLET": [
    {
      "make": "Chevrolet",
      "model": "Silverado",
      "year_from": 2018,
      "year_to": 2025,
      "variant": "LT",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "Chevrolet",
      "model": "Silverado",
      "year_from": 2018,
      "year_to": 2025,
      "variant": "LTZ",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    }
  ],
  "JEEP": [
    {
      "make": "Jeep",
      "model": "Gladiator",
      "year_from": 2020,
      "year_to": 2025,
      "variant": "Overland",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "Jeep",
      "model": "Gladiator",
      "year_from": 2020,
      "year_to": 2025,
      "variant": "Rubicon",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "Jeep",
      "model": "Wrangler",
      "year_from": 2007,
      "year_to": 2025,
      "variant": "Sport",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "Jeep",
      "model": "Wrangler",
      "year_from": 2007,
      "year_to": 2025,
      "variant": "Rubicon",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "Jeep",
      "model": "Grand Cherokee",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "Laredo",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "Jeep",
      "model": "Grand Cherokee",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "Limited",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    },
    {
      "make": "Jeep",
      "model": "Grand Cherokee",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "Overland",
      "has_2inch_hitch": true,
      "notes": "Factory 2\" receiver (US import - verify Australian spec)"
    }
  ],
  "MITSUBISHI": [
    {
      "make": "Mitsubishi",
      "model": "Triton",
      "year_from": 2006,
      "year_to": 2025,
      "variant": "GLX",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory - not factory standard equipment"
    },
    {
      "make": "Mitsubishi",
      "model": "Triton",
      "year_from": 2006,
      "year_to": 2025,
      "variant": "GLS",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory - not factory standard equipment"
    },
    {
      "make": "Mitsubishi",
      "model": "Triton",
      "year_from": 2006,
      "year_to": 2025,
      "variant": "GSR",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted accessory - not factory standard equipment"
    },
    {
      "make": "Mitsubishi",
      "model": "Pajero Sport",
      "year_from": 2016,
      "year_to": 2025,
      "variant": "GLS",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted genuine accessory - not factory standard equipment"
    },
    {
      "make": "Mitsubishi",
      "model": "Pajero Sport",
      "year_from": 2016,
      "year_to": 2025,
      "variant": "Exceed",
      "has_2inch_hitch": false,
      "notes": "Dealer-fitted genuine accessory - not factory standard equipment"
    }
  ],
  "MAZDA": [
    {
      "make": "Mazda",
      "model": "BT-50",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "XT",
      "has_2inch_hitch": false,
      "notes": "Aftermarket or genuine accessory required - not factory standard"
    },
    {
      "make": "Mazda",
      "model": "BT-50",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "XTR",
      "has_2inch_hitch": false,
      "notes": "Aftermarket or genuine accessory required - not factory standard"
    },
    {
      "make": "Mazda",
      "model": "BT-50",
      "year_from": 2011,
      "year_to": 2025,
      "variant": "GT",
      "has_2inch_hitch": false,
      "notes": "Aftermarket or genuine accessory required - not factory standard"
    },
    {
      "make": "Mazda",
      "model": "BT-50",
      "year_from": 2020,
      "year_to": 2025,
      "variant": "Thunder",
      "has_2inch_hitch": false,
      "notes": "Aftermarket or genuine accessory required - not factory standard"
    },
    {
      "make": "Mazda",
      "model": "CX-9",
      "year_from": 2016,
      "year_to": 2025,
      "variant": "Sport",
      "has_2inch_hitch": false,
      "notes": "Genuine Mazda accessory available - not standard equipment. Affects foot-sensing tailgate if fitted"
    },
    {
      "make": "Mazda",
      "model": "CX-9",
      "year_from": 2016,
      "year_to": 2025,
      "variant": "Touring",
      "has_2inch_hitch": false,
      "notes": "Genuine Mazda accessory available - not standard equipment. Affects foot-sensing tailgate if fitted"
    },
    {
      "make": "Mazda",
      "model": "CX-9",
      "year_from": 2016,
      "year_to": 2025,
      "variant": "GT",
      "has_2inch_hitch": false,
      "notes": "Genuine Mazda accessory available - not standard equipment. Affects foot-sensing tailgate if fitted"
    },
    {
      "make": "Mazda",
      "model": "CX-9",
      "year_from": 2016,
      "year_to": 2025,
      "variant": "Azami",
      "has_2inch_hitch": false,
      "notes": "Genuine Mazda accessory available - not standard equipment. Affects foot-sensing tailgate if fitted"
    },
    {
      "make": "Mazda",
      "model": "CX-8",
      "year_from": 2018,
      "year_to": 2025,
      "variant": "Sport",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    },
    {
      "make": "Mazda",
      "model": "CX-8",
      "year_from": 2018,
      "year_to": 2025,
      "variant": "Touring",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    }
  ],
  "GWM": [
    {
      "make": "GWM",
      "model": "Ute",
      "year_from": 2020,
      "year_to": 2025,
      "variant": "Cannon",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    },
    {
      "make": "GWM",
      "model": "Ute",
      "year_from": 2020,
      "year_to": 2025,
      "variant": "Cannon-L",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    }
  ],
  "LDV": [
    {
      "make": "LDV",
      "model": "T60",
      "year_from": 2017,
      "year_to": 2025,
      "variant": "Pro",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    },
    {
      "make": "LDV",
      "model": "T60",
      "year_from": 2017,
      "year_to": 2025,
      "variant": "Luxe",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    },
    {
      "make": "LDV",
      "model": "T60",
      "year_from": 2017,
      "year_to": 2025,
      "variant": "Trailrider",
      "has_2inch_hitch": false,
      "notes": "Aftermarket towbar required - not factory equipped"
    }
  ]
};

// Matching logic
function normalise(str) {
  return (str || '').toUpperCase().replace(/[^A-Z0-9 ]/g, '').replace(/\s+/g, ' ').trim();
}

function matchVehicle(make, model, year, variant) {
  const normMake = normalise(make);
  let makeEntries = compatibilityDB[normMake];

  if (!makeEntries) {
    const makeKey = Object.keys(compatibilityDB).find(k => normMake.includes(k) || k.includes(normMake));
    if (makeKey) makeEntries = compatibilityDB[makeKey];
  }

  if (!makeEntries) return null;

  const normModel = normalise(model);
  const normVariant = normalise(variant);
  const yearNum = parseInt(year, 10);

  const scored = makeEntries.map(entry => {
    let score = 0;
    const entryModel = normalise(entry.model);
    const entryVariant = normalise(entry.variant);

    if (normModel === entryModel) score += 10;
    else if (normModel.includes(entryModel) || entryModel.includes(normModel)) score += 5;
    else return { entry, score: 0 };

    if (yearNum >= entry.year_from && yearNum <= entry.year_to) score += 5;
    else return { entry, score: 0 };

    if (entryVariant && normVariant) {
      if (normVariant === entryVariant) score += 8;
      else if (normVariant.includes(entryVariant) || entryVariant.includes(normVariant)) score += 3;
    }

    return { entry, score };
  });

  scored.sort((a, b) => b.score - a.score);
  return scored[0]?.score > 0 ? scored[0].entry : null;
}

export default async function handler(req, res) {
  // Set CORS headers
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  const { rego, state } = req.body;

  if (!rego || !state) {
    return res.status(400).json({ error: 'rego and state are required' });
  }

  const username = 'jbracks';

  try {
    const apiUrl = `https://www.regcheck.org.uk/api/reg.asmx/CheckAustralia?RegistrationNumber=${encodeURIComponent(rego)}&username=${encodeURIComponent(username)}&State=${encodeURIComponent(state)}`;

    console.log('Calling RegCheck API:', apiUrl);

    const apiRes = await fetch(apiUrl);
    const xml = await apiRes.text();

    console.log('Response status:', apiRes.status);
    console.log('Response (first 500 chars):', xml.substring(0, 500));

    // Check for errors
    const errorMatch = xml.match(/<Message>([\s\S]*?)<\/Message>/);
    if (errorMatch) {
      return res.status(400).json({
        error: 'RegCheck API error',
        details: errorMatch[1]
      });
    }

    // Extract vehicleJson
    const jsonMatch = xml.match(/<vehicleJson>([\s\S]*?)<\/vehicleJson>/);
    if (!jsonMatch) {
      return res.status(404).json({
        error: 'Vehicle not found',
        details: 'No vehicle data returned from RegCheck API'
      });
    }

    // Parse JSON
    const jsonStr = jsonMatch[1]
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .replace(/&quot;/g, '"');

    const vehicle = JSON.parse(jsonStr);

    // Extract fields
    const make = vehicle.CarMake?.CurrentTextValue || '';
    const model = vehicle.CarModel?.CurrentTextValue || '';
    const year = vehicle.RegistrationYear || '';
    const variant = vehicle.extended?.variant || vehicle.extended?.series || '';

    // Match against compatibility DB
    const match = matchVehicle(make, model, year, variant);

    // Return result
    return res.status(200).json({
      vehicle: {
        make,
        model,
        year,
        variant,
        description: vehicle.Description || `${make} ${model}`,
        state: vehicle.State || state,
      },
      fitment: match
        ? {
            compatible: match.has_2inch_hitch,
            notes: match.notes || null,
            matchedEntry: {
              make: match.make,
              model: match.model,
              variant: match.variant,
              yearRange: `${match.year_from}-${match.year_to}`,
            },
          }
        : {
            compatible: null,
            notes: 'Vehicle not found in our compatibility database. Contact us for help.',
            matchedEntry: null,
          },
    });

  } catch (err) {
    console.error('Error:', err);
    return res.status(500).json({
      error: err.message,
      stack: err.stack,
      type: err.name
    });
  }
}
